<!doctype html>
<html lang="en">
<head>
  <link rel="preload" href="{{ url_for('static', filename='style.css') }}" as="style">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taxa treenaus</title>
</head>
<body>
  <main class="wrap">
    <header class="top">
      <h1>Taxatreeni</h1>
      <div style="display:flex; gap:10px;">
        <a class="btn secondary" href="/manual">Ohjeet</a>
        <a class="btn secondary" href="/settings">Asetukset</a>
      </div>
    </header>

      <div class="actions">
        <button id="showBtn" class="btn secondary" type="button">Näytä</button>
        <button id="newBtn" class="btn">Uusi</button>
      </div>
    <section class="card">
      <div class="hint">
        <div> <strong><span id="fin">{{ item.meta.fin }}</span></strong></div>
      </div>

      <div id="imgBox" class="imgBox" style="display: none;">
        <img id="img" alt="example" />
      </div>

      <!-- <div id="givenBox" class="given" style="display:none;"> -->
      <!--   <div><strong>Annettu:</strong> <span id="givenText"></span></div> -->
      <!-- </div> -->

      <form id="form" autocomplete="off">
        {% for r in ranks %}

          <label class="row" id="row_{{ r }}">
            <span class="rank">
              {{ rank_fi.get(r, "") }}
            </span>

            <div class="cell">
              <span class="staticVal" id="in_{{ r }}">—</span>
              <button type="button" class="miniBtn" id="btn_{{ r }}">?</button>
            </div>

            <div class="result" id="res_{{ r }}" hidden></div>
          </label>
        {% endfor %}
      </form>


      <pre id="answers" class="answers" style="display:none;"></pre>
    </section>
  </main>

  <script>
    const RANK_FI = {{ rank_fi|tojson }};

    let current = {
      answer: {{ item.answer|tojson }},
      meta: {{ item.meta|tojson }},
      quiz_ranks: {{ ranks|tojson }},     // ranks rendered for THIS card
      mode: {{ quiz_mode|tojson }},
      given: {{ given|tojson }},
    };

    function getRanks() {
      return current.quiz_ranks || [];
    }

    function norm(s) {
      return (s ?? "").toString().trim().toLowerCase().replace(/\s+/g, " ");
    }


function applyVisibleFieldsFromAnswer(answer) {
  for (const r of getRanks() ) {
    const row = document.getElementById("row_" + r);
    const input = document.getElementById("in_" + r);

    // If ids don't match, don't crash silently
    if (!row || !input) {
      console.warn("Missing DOM for rank:", r, { row, input });
      continue;
    }

    const raw = answer?.[r];
    const expected = (raw === null || raw === undefined) ? "" : String(raw);
    const shouldShow = expected.trim().length > 0;

    row.hidden = !shouldShow; //

    if (!shouldShow) {
      input.value = "";
      input.classList.remove("ok", "bad");
    }
  }
}

    function setImage(meta) {
      const imgBox = document.getElementById("imgBox");
      const img = document.getElementById("img");
      if (meta && meta.image) {
        img.src = meta.image;
        imgBox.style.display = "block";
      } else {
        img.removeAttribute("src");
        imgBox.style.display = "none";
      }
    }

    function updateMeta(meta) {
      setImage(meta);
      renderGivenBox(); // updates fin + given text together
    }

function clearInputs() {
  for (const r of getRanks()) {
    const el = document.getElementById("in_" + r);
    el.textContent = "—";
    el.classList.remove("ok", "bad");
  }
  document.getElementById("answers").style.display = "none";
  for (const r of getRanks()) {
    const res = document.getElementById("res_" + r);
    if (res) res.hidden = true;
  }
}

function hintFill(rank) {
  const el = document.getElementById("in_" + rank);
  const expected = (current.answer?.[rank] ?? "").toString();

  if (!expected.trim()) return;

  el.textContent = expected;
  el.classList.add("ok");
}
async function checkAll() {
  const inputs = {};
  for (const r of getRanks()) {
    inputs[r] = document.getElementById("in_" + r).value;
  }

  const res = await fetch("/check", {
    method: "POST",
    credentials: "same-origin",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ inputs, quiz_ranks: getRanks() })
  });

  const data = await res.json();
  if (data.error) {
    console.warn("Check error:", data.error);
    return;
  }

  for (const r of getRanks()) {
    const el = document.getElementById("in_" + r);
    const v = (data[r] ? data[r].correct : null);

    el.classList.remove("ok", "bad");
    if (v === true) el.classList.add("ok");
    if (v === false) el.classList.add("bad");
  }
}

function showAnswers() {
  for (const r of getRanks()) {
    const el = document.getElementById("in_" + r);
    el.textContent = current.answer?.[r] ?? "";
    el.classList.add("ok");
  }
}
async function newItem() {
  const res = await fetch("/new", {
    method: "POST",
    credentials: "same-origin"
  });
  const data = await res.json();

  current = data; // now includes answer/meta/mode/given/quiz_ranks

  updateMeta(current.meta);
  renderGivenBox();
  buildForm();
  clearInputs();
}

function renderGivenBox() {
  const finEl = document.getElementById("fin");

  const baseFin = current?.meta?.fin ?? "";
  const given = current?.given;

  if (given && given.value) {
    const rankFi = RANK_FI[given.rank] || given.rank;
    <!-- finEl.textContent = `${baseFin} (${rankFi}: ${given.value})`; -->
    finEl.textContent = `${baseFin} `;
  } else {
    finEl.textContent = baseFin;
  }
}


function buildForm() {
  const form = document.getElementById("form");
  const ranks = getRanks();

  form.innerHTML = ranks.map(r => `
    <label class="row" id="row_${r}">
      <span class="rank">${(RANK_FI[r] || r)}</span>

      <div class="cell">
        <span class="staticVal" id="in_${r}">—</span>
        <button type="button" class="miniBtn" id="btn_${r}">?</button>
      </div>

      <div class="result" id="res_${r}" hidden></div>
    </label>
  `).join("");

  // bind hint buttons
  for (const r of ranks) {
    document.getElementById("btn_" + r).addEventListener("click", () => {
      hintFill(r);
    });
  }

  applyVisibleFieldsFromAnswer(current.answer);
}
    // live checking as you type

    document.getElementById("newBtn").addEventListener("click", () => newItem().catch(console.error));
    document.getElementById("showBtn").addEventListener("click", showAnswers);


    // initial
    updateMeta(current.meta);
    setImage(current.meta);
    renderGivenBox();
    buildForm(); // binds listeners + hides empty fields

    <!-- updateMeta(current.meta); -->
    <!-- setImage(current.meta); -->
    <!-- // applyDisabledFieldsFromAnswer(current.answer); -->
    <!-- applyVisibleFieldsFromAnswer(current.answer); -->

    document.addEventListener("keydown", (e) => {
      // don't trigger while typing in an input
      const tag = (e.target?.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea") return;

      if (e.key.toLowerCase() === "s") {
        e.preventDefault();
        showAnswers();
      }
    });

    document.addEventListener("keydown", (e) => {
      // don't trigger while typing in an input
      const tag = (e.target?.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea") return;

      if (e.key.toLowerCase() === "n") {
        e.preventDefault();
        newItem();
      }
    });
  </script>
</body>
</html>
